<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Onglets Grist (configurables)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --radius:12px; --shadow:0 6px 18px rgba(0,0,0,.08); --muted:#667085; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:16px; box-sizing:border-box; background:#f8fafc; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab { border:1px solid #e5e7eb; background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; }
    .tab.active { background:#111827; color:#fff; border-color:#111827; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; }
    table.kv { width:100%; border-collapse:collapse; }
    table.kv th { text-align:left; color:#111827; padding:8px 10px; width:240px; background:#f9fafb; border-bottom:1px solid #eee; }
    table.kv td { padding:8px 10px; border-bottom:1px solid #f1f5f9; }
    table.grid { width:100%; border-collapse:collapse; margin-top:8px; }
    table.grid th, table.grid td { padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; }
    .muted { color:var(--muted); font-style:italic; padding:6px 2px; }
    .caption { margin:6px 0 12px; color:#334155; }
    .help { font-size:12px; color:#64748b; margin-top:8px; }
    .divider { height:1px; background:#e5e7eb; margin:10px 0; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #CBD5E1; background:#FFF; font-size:12px; color:#334155; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="row">
    <div id="tabs" class="tabs"></div>
    <span class="pill">Astuce : ajoutez des onglets dans la table <b>tab_onglets</b> (Label, Type, Ancre ou ChildTable/FK/Columns)</span>
  </div>
  <div id="caption" class="caption"></div>
  <div id="content" class="panel"></div>

  <script>
  // --------- CONFIG DE BASE ---------
  const FIXED_TABS = [
    { id:'presentation', label:'Présentation', fields:'*' },
    { id:'procedure',    label:'Procédure',    fields:['Etapes','date_de_debut','date_de_fin','Date_de_fin_suggeree'] },
    { id:'pj',           label:'Pièces jointes',
      child: { table: 'tab_PJ_signalement', fk: 'Dossier', columns: ['Nom_fichier','Type','Date','Fichiers'] }
    }
  ];
  // Table de configuration des onglets personnalisés (à créer dans Grist)
  // Colonnes attendues (IDs exacts): Dossier(Ref signalements), Label(Text), Type(Choice: 'Lien'|'Enfant'),
  // Ancre(Text pour les liens), ChildTable(Text), FK(Text), Columns(Text CSV), Ordre(Numeric)
  const CONFIG_TABLE = 'tab_onglets';
  // ----------------------------------

  const state = { record:null, token:null, currentTab:null, docInfo:null, configRows:[] };

  function h(tag, attrs={}, ...children) {
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs||{})) {
      if (k === 'class') el.className = v;
      else if (k.startsWith('on')) el.addEventListener(k.slice(2), v);
      else el.setAttribute(k, v);
    }
    for (const ch of children) el.append(ch?.nodeType ? ch : document.createTextNode(ch ?? ''));
    return el;
  }

  function selectTab(id){ state.currentTab = id; renderTabs(); renderContent(); }

  function buildUrlFromAnchorExample(anchorExample, rowId) {
    if (!anchorExample) return null;
    let url = String(anchorExample);
    url = url.replace(/r\d+/g, 'r' + rowId);
    url = url.replace('{ROW}', rowId).replace('{ID}', rowId);
    return url;
  }

  function parseCsv(s) { if (!s) return []; return String(s).split(',').map(x => x.trim()).filter(Boolean); }

  function pretty(v){
    if (v == null) return '';
    if (v && typeof v === 'object' && v.hasOwnProperty('value')) return String(v.value);
    if (v instanceof Date) return v.toLocaleString();
    if (Array.isArray(v)) return v.join(', ');
    if (typeof v === 'object') return JSON.stringify(v);
    return String(v);
  }

  function attachmentUrl(id){
    if (!state.token) return '#';
    return `${state.token.baseUrl}/attachments/${id}/download?auth=${state.token.token}`;
  }

  function fieldListFor(record, fieldsSetting) {
    if (!record) return [];
    if (fieldsSetting === '*') {
      const hide = new Set(['id']);
      return Object.keys(record).filter(k => !hide.has(k));
    }
    return fieldsSetting || [];
  }

  function renderTabs() {
    const bar = h('div', {class:'tabs'});
    const active = state.currentTab ?? (FIXED_TABS[0]?.id || state.configRows[0]?.__tabId);
    for (const t of FIXED_TABS) {
      const btn = h('button', {class:'tab' + (t.id===active?' active':''), onclick:()=>selectTab(t.id)}, t.label);
      bar.append(btn);
    }
    for (const r of state.configRows) {
      const id = r.__tabId;
      const btn = h('button', {class:'tab' + (id===active?' active':''), onclick:()=>selectTab(id)}, r.Label || 'Onglet');
      bar.append(btn);
    }
    document.getElementById('tabs').replaceChildren(bar);

    const cap = document.getElementById('caption');
    const docName = state.docInfo?.docName || '';
    const tableId = state.docInfo?.tableId || '';
    cap.textContent = (state.record)
      ? `Dossier #${state.record.id} — ${docName} › ${tableId}`
      : `Sélectionnez un dossier dans la table liée.`;
  }

  async function renderContent() {
    const cont = document.getElementById('content');
    cont.innerHTML = '';
    const activeId = state.currentTab ?? (FIXED_TABS[0]?.id || state.configRows[0]?.__tabId);
    if (!activeId) { cont.textContent = 'Aucun onglet configuré.'; return; }

    const t = FIXED_TABS.find(x => x.id === activeId);
    if (t) {
      if (t.fields && state.record) {
        const table = h('table', {class:'kv'});
        for (const f of fieldListFor(state.record, t.fields)) {
          table.append(h('tr', {}, h('th', {}, f), h('td', {}, pretty(state.record[f]))));
        }
        cont.append(table);
      }
      if (t.child && state.record) {
        try {
          const rows = await grist.docApi.fetchTable(t.child.table);
          const recId = state.record.id;
          const subset = rows.filter(r => {
            const v = r[t.child.fk];
            return Array.isArray(v) ? v.includes(recId) : v === recId;
          });
          if (!subset.length) {
            cont.append(h('div',{class:'muted'}, 'Aucune donnée liée.'));
          } else {
            const grid = h('table',{class:'grid'});
            const head = h('tr',{}); for (const c of t.child.columns) head.append(h('th',{}, c));
            grid.append(head);
            for (const r of subset) {
              const tr = h('tr',{});
              for (const c of t.child.columns) {
                if (c === 'Fichiers' && Array.isArray(r[c]) && r[c].length) {
                  const wrap = h('div',{});
                  for (const id of r[c]) wrap.append(h('a', {href: attachmentUrl(id), target:'_blank'}, 'Télécharger'), document.createTextNode(' '));
                  tr.append(h('td',{}, wrap));
                } else {
                  tr.append(h('td',{}, pretty(r[c])));
                }
              }
              grid.append(tr);
            }
            cont.append(grid);
          }
        } catch (e) {
          cont.append(h('div',{class:'muted'}, 'Impossible de charger la table liée : ' + e));
        }
      }
      return;
    }

    const row = state.configRows.find(x => x.__tabId === activeId);
    if (!row) { cont.textContent = 'Onglet non trouvé.'; return; }
    const type = String(row.Type || '').toLowerCase();

    if (type === 'lien') {
      const url = buildUrlFromAnchorExample(row.Ancre, state.record?.id);
      if (!url) {
        cont.append(h('div',{class:'muted'}, 'Onglet "Lien" sans URL/Ancre. Éditez la ligne dans tab_onglets.'));
        return;
      }
      const a1 = h('a', {href:url, target:'_parent'}, 'Ouvrir « ' + (row.Label || 'onglet') + ' »');
      const a2 = h('a', {href:url, target:'_blank', style:'margin-left:12px'}, '(ouvrir dans un nouvel onglet)');
      cont.append(h('div',{}, a1, a2, h('div',{class:'help'}, 'Astuce : copiez l’ancre sur la page cible (clic droit → Copier le lien d’ancrage) puis collez-la dans "Ancre".')));
      return;
    }

    if (type === 'enfant') {
      if (!row.ChildTable || !row.FK) {
        cont.append(h('div',{class:'muted'}, 'Onglet "Enfant" incomplet : renseignez ChildTable et FK.'));
        return;
      }
      try {
        const rows = await grist.docApi.fetchTable(row.ChildTable);
        const recId = state.record?.id;
        const subset = rows.filter(r => {
          const v = r[row.FK];
          return Array.isArray(v) ? v.includes(recId) : v === recId;
        });
        if (!subset.length) {
          cont.append(h('div',{class:'muted'}, 'Aucune donnée liée.'));
          return;
        }
        const cols = parseCsv(row.Columns).length ? parseCsv(row.Columns) : Object.keys(subset[0] || {});
        const grid = h('table',{class:'grid'});
        const head = h('tr',{}); for (const c of cols) head.append(h('th',{}, c));
        grid.append(head);
        for (const r of subset) {
          const tr = h('tr',{});
          for (const c of cols) {
            if (c === 'Fichiers' && Array.isArray(r[c]) && r[c].length) {
              const wrap = h('div',{});
              for (const id of r[c]) wrap.append(h('a', {href: attachmentUrl(id), target:'_blank'}, 'Télécharger'), document.createTextNode(' '));
              tr.append(h('td',{}, wrap));
            } else {
              tr.append(h('td',{}, pretty(r[c])));
            }
          }
          grid.append(tr);
        }
        cont.append(grid);
      } catch (e) {
        cont.append(h('div',{class:'muted'}, 'Impossible de charger la table enfant : ' + e));
      }
      return;
    }

    cont.append(h('div',{class:'muted'}, 'Type d’onglet non reconnu. Utilisez "Lien" ou "Enfant".'));
  }

  async function loadConfigForCurrentRecord() {
    state.configRows = [];
    try {
      const all = await grist.docApi.fetchTable(CONFIG_TABLE);
      const recId = state.record?.id;
      const mine = all.filter(r => r.Dossier === recId || (Array.isArray(r.Dossier) && r.Dossier.includes(recId)));
      state.configRows = mine
        .map((r, i) => ({ ...r, __tabId: 'cfg_' + (r.id ?? i) }))
        .sort((a,b) => (a.Ordre ?? 0) - (b.Ordre ?? 0));
    } catch (e) {
      state.configRows = [];
    }
  }

  async function init() {
    grist.ready({ requiredAccess: 'full' });
    state.docInfo = await grist.docApi.getDocInfo().catch(() => ({}));
    grist.onRecord(async (record) => {
      state.record = record || null;
      if (!state.token) {
        state.token = await grist.docApi.getAccessToken({ readOnly: true }).catch(() => null);
      }
      await loadConfigForCurrentRecord();
      renderTabs();
      renderContent();
    });
  }

  init();
  </script>
</body>
</html>
